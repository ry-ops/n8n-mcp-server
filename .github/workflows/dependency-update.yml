name: Dependency Updates

on:
  schedule:
    # Run weekly on Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  update-dependencies:
    name: Check for Dependency Updates
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v3

      - name: Set up Python
        run: uv python install 3.10

      - name: Create virtual environment
        run: uv venv

      - name: Install dependencies
        run: uv pip install -e .

      - name: Check for updates
        id: check-updates
        run: |
          # Check for outdated packages
          uv pip list --outdated > outdated.txt || true

          # Count outdated packages (excluding header lines if any)
          if [ -s outdated.txt ]; then
            OUTDATED_COUNT=$(wc -l < outdated.txt | tr -d ' ')
          else
            OUTDATED_COUNT=0
          fi
          echo "outdated_count=${OUTDATED_COUNT}" >> $GITHUB_OUTPUT

          # Display results
          cat outdated.txt

      - name: Create issue for outdated dependencies
        if: steps.check-updates.outputs.outdated_count > 0
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            try {
              const outdated = fs.readFileSync('outdated.txt', 'utf8');

              if (outdated.trim().length > 0) {
                const body = `## Outdated Dependencies\n\nThe following dependencies are outdated:\n\n\`\`\`\n${outdated}\n\`\`\`\n\n**Action Required:** Review and update these dependencies to maintain security and compatibility.\n\n**Workflow Run:** ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

                // Check if issue already exists
                const issues = await github.rest.issues.listForRepo({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  state: 'open',
                  labels: 'dependencies'
                });

                const existingIssue = issues.data.find(issue =>
                  issue.title === 'Dependencies need updating'
                );

                if (existingIssue) {
                  // Update existing issue
                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: existingIssue.number,
                    body: `**Updated:** ${new Date().toISOString()}\n\n${body}`
                  });
                } else {
                  // Create new issue
                  await github.rest.issues.create({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    title: 'Dependencies need updating',
                    body: body,
                    labels: ['dependencies', 'maintenance']
                  });
                }
              }
            } catch (error) {
              console.log('Error processing outdated packages:', error.message);
            }
